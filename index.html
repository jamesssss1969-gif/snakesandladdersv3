<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metronome Board Game</title>

<style>
body{
  background:#0f172a;
  color:#e5e7eb;
  font-family:system-ui,sans-serif;
  display:flex;
  justify-content:center;
  padding:20px;
}
.panel{
  background:#020617;
  padding:20px;
  border-radius:16px;
  width:380px;
  max-width:95vw;
}
h1{text-align:center;margin-top:0}
#square{text-align:center;font-size:2rem;margin:10px 0}
#bpm{text-align:center;color:#9ca3af}
img{
  width:100%;
  border-radius:12px;
  margin:10px 0;
}
input,button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:999px;
  border:none;
  font-size:1rem;
}
button{background:#1d4ed8;color:#fff;font-weight:600}
input{background:#111827;color:#e5e7eb}
</style>
</head>

<body>
<div class="panel">
<h1>Roll & Obey</h1>

<div id="square">Square 1</div>
<div id="bpm">BPM: â€”</div>

<input id="subreddit" placeholder="subreddit (e.g. gifs)">
<button id="rollBtn">Roll Dice</button>

<div id="media"></div>

<audio id="clickSound" preload="auto">
  <source src="data:audio/wav;base64,UklGRhQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=">
</audio>

</div>

<script>
let square = 1;
const snakes = {16:6,48:30,79:19};
const ladders = {3:22,11:26,20:38,41:60};

const click = document.getElementById('clickSound');

function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function randTime(){return rand(10,30)*1000;}

function bpmForSquare(n){
  if(n<=10) return rand(1,2);
  if(n<=30) return rand(2,3);
  if(n<=60) return rand(3,4);
  if(n<=90) return rand(4,5);
  return rand(5,6);
}

async function loadImage(sub){
  try{
    const r = await fetch(`https://www.reddit.com/r/${sub}.json?raw_json=1`);
    const j = await r.json();
    const posts = j.data.children
      .map(p=>p.data)
      .filter(p=>p.url && p.url.match(/i\.redd\.it|preview\.redd\.it/));
    if(!posts.length) return null;
    return posts[rand(0,posts.length-1)].url;
  }catch{
    return null;
  }
}

function startMetronome(bpm,duration){
  const interval = 60000/bpm;
  const end = Date.now()+duration;
  const t = setInterval(()=>{
    click.currentTime=0;
    click.play();
    if(Date.now()>end) clearInterval(t);
  },interval);
}

rollBtn.onclick = async()=>{
  const roll = rand(1,6);
  square += roll;
  if(snakes[square]) square = snakes[square];
  if(ladders[square]) square = ladders[square];
  if(square>100) square=100;

  squareDiv.textContent = `Square ${square}`;

  const bpm = bpmForSquare(square);
  bpmDiv.textContent = `BPM: ${bpm}`;

  media.innerHTML='';

  const img = await loadImage(subreddit.value || 'gifs');
  if(img){
    const i=document.createElement('img');
    i.src=img;
    media.appendChild(i);
  }

  startMetronome(bpm,randTime());
};

const squareDiv = document.getElementById('square');
const bpmDiv = document.getElementById('bpm');
</script>
</body>
</html>
