<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metronome Board Game</title>

<style>
body{
  background:#0f172a;
  color:#e5e7eb;
  font-family:system-ui,sans-serif;
  display:flex;
  justify-content:center;
  padding:20px;
}
.panel{
  background:#020617;
  padding:20px;
  border-radius:16px;
  width:380px;
  max-width:95vw;
}
h1{text-align:center;margin-top:0}
#square{text-align:center;font-size:2rem;margin:10px 0}
#bpm{text-align:center;color:#9ca3af}
img,video{
  width:100%;
  border-radius:12px;
  margin:10px 0;
}
input,button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:999px;
  border:none;
  font-size:1rem;
}
button{background:#1d4ed8;color:#fff;font-weight:600}
input{background:#111827;color:#e5e7eb}
</style>
</head>

<body>
<div class="panel">
<h1>Roll & Obey</h1>

<div id="square">Square 1</div>
<div id="bpm">BPM: â€”</div>

<input id="subreddit" placeholder="subreddit (e.g. gifs)">
<button id="rollBtn">Roll Dice</button>

<div id="media"></div>
</div>

<script>
/* ===== AUDIO ===== */
let audioCtx;
function initAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  }
  audioCtx.resume();
}

function metronome(bpm,duration){
  const interval = 60000/bpm;
  const end = Date.now()+duration;
  const t = setInterval(()=>{
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.frequency.value = 1000;
    g.gain.value = 0.2;
    o.connect(g).connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime+0.05);
    if(Date.now()>end) clearInterval(t);
  },interval);
}

/* ===== GAME DATA ===== */
let square = 1;
const snakes = {16:6,48:30,79:19};
const ladders = {3:22,11:26,20:38,41:60};

/* ===== HELPERS ===== */
function bpmForSquare(n){
  if(n<=10) return rand(1,2);
  if(n<=30) return rand(2,3);
  if(n<=60) return rand(3,4);
  if(n<=90) return rand(4,5);
  return rand(5,6);
}
function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
function randTime(){return rand(10,30)*1000;}

/* ===== REDDIT ===== */
async function loadMedia(sub){
  const res = await fetch(`https://www.reddit.com/r/${sub}.json?limit=50`);
  const json = await res.json();
  const posts = json.data.children
    .map(p=>p.data)
    .filter(p=>p.url && (p.url.includes('i.redd.it')||p.url.includes('preview.redd.it')||p.is_video));
  if(!posts.length) return null;
  return posts[rand(0,posts.length-1)];
}

function showPost(post){
  media.innerHTML='';
  if(post.is_video && post.media?.reddit_video){
    const v=document.createElement('video');
    v.src=post.media.reddit_video.fallback_url;
    v.autoplay=true;v.loop=true;v.muted=true;
    media.appendChild(v);
  }else{
    const i=document.createElement('img');
    i.src=post.url;
    media.appendChild(i);
  }
}

/* ===== MAIN ===== */
rollBtn.onclick=async()=>{
  initAudio();

  const roll = rand(1,6);
  square += roll;
  if(snakes[square]) square = snakes[square];
  if(ladders[square]) square = ladders[square];
  if(square>100) square=100;

  document.getElementById('square').textContent=`Square ${square}`;

  const bpm = bpmForSquare(square);
  document.getElementById('bpm').textContent=`BPM: ${bpm}`;

  const post = await loadMedia(subreddit.value||'gifs');
  if(post) showPost(post);

  metronome(bpm,randTime());
};
</script>
</body>
</html>
